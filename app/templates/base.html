<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Что готовить{% endblock %}</title>
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    {% block head %}{% endblock %}
</head>
<body class="h-full bg-background text-foreground">
    <!-- Навигация -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="{{ url_for('index') }}" class="navbar-brand">
                <span>Что готовить</span>
            </a>
            
            <div class="navbar-menu">
                <a href="{{ url_for('index') }}" class="nav-link {% if request.endpoint == 'index' %}active{% endif %}">
                    <i class="bi bi-house-door"></i> Главная
                </a>
                
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('user.calculate') }}" class="nav-link {% if request.endpoint == 'user.calculate' %}active{% endif %}">
                        <i class="bi bi-calculator-fill"></i> Расчёт
                    </a>
                    <a href="{{ url_for('user.my_ingredients') }}" class="nav-link {% if request.endpoint == 'user.my_ingredients' %}active{% endif %}">
                        <i class="bi bi-basket"></i> Ингредиенты
                    </a>
                    <a href="{{ url_for('user.my_recipes') }}" class="nav-link {% if request.endpoint == 'user.my_recipes' %}active{% endif %}">
                        <i class="bi bi-journal-text"></i> Рецепты
                    </a>
                    
                    {% if current_user.is_admin %}
                        <a href="{{ url_for('admin.ingredients') }}" class="nav-link {% if request.endpoint == 'admin.ingredients' %}active{% endif %}">
                            <i class="bi bi-shield-check"></i> Админ
                        </a>
                    {% endif %}
                {% endif %}
            </div>
            
            <div class="flex items-center gap-4">
                {% if current_user.is_authenticated %}
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-sm font-medium">
                            {{ current_user.username[0]|upper }}
                        </div>
                    <span class="text-sm">{{ current_user.username }}</span>
                </div>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-outline btn-sm">
                    <i class="bi bi-box-arrow-right"></i>
                </a>
            {% else %}
                <button onclick="openModal('loginModal')" class="btn btn-outline btn-sm">
                    Войти
                </button>
                <button onclick="openModal('registerModal')" class="btn btn-primary btn-sm">
                    Регистрация
                </button>
            {% endif %}
        </div>
        </div>
    </nav>
    <!-- Flash сообщения -->
    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="space-y-2">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} fade-in">
                            <i class="bi 
                                {% if category == 'success' %}bi-check-circle
                                {% elif category == 'error' or category == 'danger' %}bi-exclamation-circle
                                {% elif category == 'warning' %}bi-exclamation-triangle
                                {% else %}bi-info-circle{% endif %}">
                            </i>
                            <span>{{ message }}</span>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
    </div>
    <!-- Основной контент -->
    <main class="main-content">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>
    <!-- Футер -->
    <footer class="footer">
        <div class="footer-content">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h4 class="font-medium text-center">Что готовить</h4>
                    <p class="text-sm text-muted mt-1 text-center">
                        Система для расчёта и управления рационом питания
                    </p>
                </div>
            </div>
        </div>
    </footer>
    <!-- Модальные окна -->
    <div id="modalContainer"></div>
    <!-- Скрипты -->
    <script>
        // Утилиты
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
            }
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        // Закрытие модальных окон по клику вне контента
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.add('hidden');
            }
        });
        
        // Удаление элементов
        document.addEventListener('DOMContentLoaded', function() {
            // Кнопки удаления
            document.querySelectorAll('[data-delete]').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const type = this.dataset.type;
                    const id = this.dataset.id;
                    const name = this.dataset.name;
                    
                    if (confirm(`Удалить "${name}"?`)) {
                        fetch(`/api/${type}/delete/${id}`, {
                            method: 'DELETE'
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Плавное удаление элемента
                                const item = this.closest('tr') || this.closest('.card') || this.closest('[data-item]');
                                if (item) {
                                    item.style.opacity = '0';
                                    item.style.transform = 'translateY(-10px)';
                                    setTimeout(() => item.remove(), 300);
                                } else {
                                    location.reload();
                                }
                            } else {
                                alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                            }
                        });
                    }
                });
            });
            
            // Переключение публичности
            document.querySelectorAll('[data-toggle-public]').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const type = this.dataset.type;
                    const id = this.dataset.id;
                    
                    fetch(`/api/${type}/toggle-public/${id}`, {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        }
                    });
                });
            });
            
            // Автоматическое скрытие flash сообщений
            setTimeout(() => {
                document.querySelectorAll('.alert').forEach(alert => {
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 300);
                });
            }, 5000);
        });
        
        // Функция для добавления полей ингредиентов
        window.addIngredientField = function(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'flex gap-2 mb-2';
            div.innerHTML = `
                <select class="form-control flex-1" name="ingredient_${index}" required>
                    <option value="">Выберите ингредиент</option>
                    {% for ing in ingredients|default([]) %}
                    <option value="{{ ing.id }}">{{ ing.name }}</option>
                    {% endfor %}
                </select>
                <input type="number" class="form-control w-24" name="amount_${index}" placeholder="г" required min="1">
                <button type="button" class="btn btn-outline btn-icon" onclick="this.parentElement.remove()">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            container.appendChild(div);
        };
    </script>
    
    {% block scripts %}{% endblock %}
    <!-- Модальное окно входа -->
<div id="loginModal" class="modal-overlay hidden">
    <div class="modal max-w-md">
        <div class="modal-header">
            <h2 class="modal-title">Вход в систему</h2>
            <button onclick="closeModal('loginModal')" class="btn btn-outline btn-icon">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="example@email.com" required>
                </div>
                
                <div>
                    <label class="form-label">Пароль</label>
                    <input type="password" id="loginPassword" class="form-control" required>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="loginRemember" class="mr-2">
                    <label for="loginRemember" class="text-sm">Запомнить меня</label>
                </div>
                
                <div id="loginError" class="text-sm text-destructive hidden"></div>
                
                <button type="submit" class="btn btn-primary w-full">
                    <i class="bi bi-box-arrow-in-right"></i> Войти
                </button>
            </form>
            
            <div class="text-center mt-6">
                <p class="text-sm text-muted mb-2">Нет аккаунта?</p>
                <button onclick="switchToRegister()" class="btn btn-outline">
                    <i class="bi bi-person-plus"></i> Зарегистрироваться
                </button>
            </div>
            
            <div class="mt-6 pt-6 border-t border-border">
                <p class="text-sm text-muted mb-2"><strong>Тестовые аккаунты:</strong></p>
                <p class="text-xs text-muted">Администратор: admin@example.com / admin123</p>
                <p class="text-xs text-muted">Пользователь: user@example.com / user123</p>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно регистрации -->
<div id="registerModal" class="modal-overlay hidden">
    <div class="modal max-w-md">
        <div class="modal-header">
            <h2 class="modal-title">Регистрация</h2>
            <button onclick="closeModal('registerModal')" class="btn btn-outline btn-icon">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <form id="registerForm" class="space-y-4">
                <div>
                    <label class="form-label">Имя пользователя</label>
                    <input type="text" id="registerUsername" class="form-control" placeholder="Введите имя" required>
                    <p class="text-xs text-muted mt-1">От 2 до 64 символов</p>
                </div>
                
                <div>
                    <label class="form-label">Email</label>
                    <input type="email" id="registerEmail" class="form-control" placeholder="example@email.com" required>
                </div>
                
                <div>
                    <label class="form-label">Пароль</label>
                    <input type="password" id="registerPassword" class="form-control" required>
                    <p class="text-xs text-muted mt-1">Не менее 6 символов</p>
                </div>
                
                <div>
                    <label class="form-label">Повторите пароль</label>
                    <input type="password" id="registerPassword2" class="form-control" required>
                </div>
                
                <div id="registerError" class="text-sm text-destructive hidden"></div>
                <button type="submit" class="btn btn-primary w-full">
                    <i class="bi bi-person-plus"></i> Зарегистрироваться
                </button>
            </form>
            
            <div class="text-center mt-6">
                <p class="text-sm text-muted mb-2">Уже есть аккаунт?</p>
                <button onclick="switchToLogin()" class="btn btn-outline">
                    <i class="bi bi-box-arrow-in-right"></i> Войти
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Скрипты для работы с модальными окнами -->
<script>
    // Переключение между модальными окнами
    function switchToRegister() {
        closeModal('loginModal');
        setTimeout(() => openModal('registerModal'), 300);
    }
    
    function switchToLogin() {
        closeModal('registerModal');
        setTimeout(() => openModal('loginModal'), 300);
    }
    
    // Обработка формы входа
    document.getElementById('loginForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const remember = document.getElementById('loginRemember').checked;
        
        const errorElement = document.getElementById('loginError');
        errorElement.classList.add('hidden');
        
        try {
            const response = await fetch('/auth/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email, password, remember })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Показываем уведомление
                showNotification(data.message, 'success');
                
                // Закрываем модальное окно
                closeModal('loginModal');
                
                // Обновляем страницу
                setTimeout(() => location.reload(), 1000);
            } else {
                errorElement.textContent = data.message;
                errorElement.classList.remove('hidden');
            }
        } catch (error) {
            errorElement.textContent = 'Ошибка сети. Попробуйте позже.';
            errorElement.classList.remove('hidden');
        }
    });
    
    // Обработка формы регистрации
    document.getElementById('registerForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('registerUsername').value;
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        const password2 = document.getElementById('registerPassword2').value;
        
        const errorElement = document.getElementById('registerError');
        errorElement.classList.add('hidden');
        
        // Базовая валидация на клиенте
        if (username.length < 2 || username.length > 64) {
            errorElement.textContent = 'Имя пользователя должно быть от 2 до 64 символов';
            errorElement.classList.remove('hidden');
            return;
        }
        
        if (password.length < 6) {
            errorElement.textContent = 'Пароль должен быть не менее 6 символов';
            errorElement.classList.remove('hidden');
            return;
        }
        
        if (password !== password2) {
            errorElement.textContent = 'Пароли не совпадают';
            errorElement.classList.remove('hidden');
            return;
        }
        
        try {
            const response = await fetch('/auth/api/register', {method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, email, password, password2 })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Показываем уведомление
                showNotification(data.message, 'success');
                
                // Закрываем модальное окно
                closeModal('registerModal');
                
                // Обновляем страницу
                setTimeout(() => location.reload(), 1000);
            } else {
                errorElement.textContent = data.message;
                errorElement.classList.remove('hidden');
            }
        } catch (error) {
            errorElement.textContent = 'Ошибка сети. Попробуйте позже.';
            errorElement.classList.remove('hidden');
        }
    });
    
    // Функция для показа уведомлений
    function showNotification(message, type = 'info') {
        // Создаём элемент уведомления
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg fade-in ${
            type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' :
            type === 'error' ? 'bg-red-50 text-red-800 border border-red-200' :
            'bg-blue-50 text-blue-800 border border-blue-200'
        }`;
        notification.innerHTML = `
            <div class="flex items-center gap-2">
                <i class="bi ${
                    type === 'success' ? 'bi-check-circle' :
                    type === 'error' ? 'bi-exclamation-circle' :
                    'bi-info-circle'
                }"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Автоматическое скрытие через 5 секунд
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(20px)';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }
    
    // Автоматическое открытие модального окна при переходе на /login или /register
    document.addEventListener('DOMContentLoaded', function() {
        if (window.location.pathname === '/auth/login' || window.location.pathname === '/login') {
            openModal('loginModal');
            window.history.replaceState({}, document.title, '/');
        } else if (window.location.pathname === '/auth/register' || window.location.pathname === '/register') {
            openModal('registerModal');
            window.history.replaceState({}, document.title, '/');
        }
    });
</script>

<!-- Общие модальные окна для приложения -->

<!-- Модальное окно добавления рецепта -->
<div id="addRecipeModal" class="modal-overlay hidden">
    <div class="modal max-w-2xl">
        <div class="modal-header">
            <h2 class="modal-title">Добавить рецепт</h2>
            <button onclick="closeModal('addRecipeModal')" class="btn btn-outline btn-icon">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <form id="addRecipeForm" class="space-y-4">
                <div>
                    <label class="form-label">Название рецепта</label>
                    <input type="text" id="recipeName" class="form-control" placeholder="Например: Курица с брокколи" required>
                </div>
                
                <div>
                    <label class="form-label">Описание (опционально)</label>
                    <textarea id="recipeDescription" class="form-control" rows="2" placeholder="Краткое описание рецепта..."></textarea>
                </div>
                
                <div id="recipeIngredientsContainer" class="space-y-3">
                    <!-- Ингредиенты будут добавляться динамически -->
                </div>
                
                <button type="button" onclick="addRecipeIngredientField()" class="btn btn-outline">
                    <i class="bi bi-plus-lg"></i> Добавить ингредиент
                </button>
                
                <div>
                    <label class="form-label">Инструкции приготовления</label>
                    <textarea id="recipeInstructions" class="form-control" rows="4" placeholder="Пошаговые инструкции..." required></textarea>
                </div>
                
                <div>
                    <label class="form-label">URL изображения (опционально)</label>
                    <input type="url" id="recipeImageUrl" class="form-control" placeholder="https://example.com/image.jpg">
                </div>
                
                <div id="recipeError" class="text-sm text-destructive hidden"></div>
                
                <div class="flex gap-3 pt-6 border-t border-border">
                    <button type="button" onclick="closeModal('addRecipeModal')" 
                            class="btn btn-outline flex-1">
                        Отмена
                    </button>
                    <button type="submit" class="btn btn-primary flex-1">
                        Сохранить рецепт
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Модальное окно просмотра рецепта -->

<div id="viewRecipeModal" class="modal-overlay hidden">
    <div class="modal max-w-2xl">
        <div class="modal-header">
            <h2 id="viewRecipeTitle" class="modal-title">Рецепт</h2>
            <button onclick="closeModal('viewRecipeModal')" class="btn btn-outline btn-icon">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <div id="viewRecipeContent">
                <!-- Контент будет загружаться динамически -->
                <div class="text-center py-8">
                    <div class="animate-spin inline-block w-6 h-6 border-2 border-primary border-t-transparent rounded-full"></div>
                    <p class="mt-2 text-muted-foreground">Загрузка...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования рецепта -->
<div id="editRecipeModal" class="modal-overlay hidden">
    <div class="modal max-w-2xl">
        <div class="modal-header">
            <h2 class="modal-title">Редактировать рецепт</h2>
            <button onclick="closeModal('editRecipeModal')" class="btn btn-outline btn-icon">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <form id="editRecipeForm" class="space-y-4">
                <div>
                    <label class="form-label">Название рецепта</label>
                    <input type="text" id="editRecipeName" class="form-control" required>
                </div>
                
                <div>
                    <label class="form-label">Описание (опционально)</label>
                    <textarea id="editRecipeDescription" class="form-control" rows="2"></textarea>
                </div>
                
                <!-- Ингредиенты -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="form-label">Ингредиенты</label>
                        <button type="button" onclick="addEditIngredientField()" class="btn btn-outline btn-sm">
                            <i class="bi bi-plus-lg"></i> Добавить
                        </button>
                    </div>
                    
                    <div id="editRecipeIngredientsContainer" class="space-y-3 mb-4">
                        <!-- Ингредиенты будут добавляться динамически -->
                    </div>
                </div>
                
                <div>
                    <label class="form-label">Инструкции приготовления</label>
                    <textarea id="editRecipeInstructions" class="form-control" rows="4" required></textarea>
                </div>
                
                <div>
                    <label class="form-label">URL изображения (опционально)</label>
                    <input type="url" id="editRecipeImageUrl" class="form-control" placeholder="https://example.com/image.jpg">
                </div>
                
                {% if current_user.is_admin %}
                <div class="flex items-center">
                    <input type="checkbox" id="editRecipeIsPublic" class="mr-2">
                    <label for="editRecipeIsPublic" class="text-sm">Сделать общедоступным</label>
                </div>
                {% endif %}
                
                <div id="editRecipeError" class="text-sm text-destructive hidden"></div>
                
                <div class="flex gap-3 pt-4 border-t border-border">
                    <button type="button" onclick="closeModal('editRecipeModal')" 
                            class="btn btn-outline flex-1">
                        Отмена
                    </button>
                    <button type="submit" class="btn btn-primary flex-1">
                        Сохранить изменения
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно добавления ингредиента -->
<div id="addIngredientModal" class="modal-overlay hidden">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Добавить ингредиент</h2>
            <button onclick="closeModal('addIngredientModal')" class="btn btn-outline btn-icon">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <form id="addIngredientForm" class="space-y-4">
                <div>
                    <label class="form-label">Название ингредиента</label>
                    <input type="text" id="ingredientName" class="form-control" placeholder="Например: Куриная грудка" required>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Калории (на 100г)</label>
                        <input type="number" step="0.1" id="ingredientCalories" class="form-control" placeholder="165" required>
                    </div>
                    <div>
                        <label class="form-label">Белки (г на 100г)</label>
                        <input type="number" step="0.1" id="ingredientProteins" class="form-control" placeholder="31" required>
                    </div>
                    <div>
                        <label class="form-label">Жиры (г на 100г)</label>
                        <input type="number" step="0.1" id="ingredientFats" class="form-control" placeholder="3.6" required>
                    </div>
                    <div>
                        <label class="form-label">Углеводы (г на 100г)</label>
                        <input type="number" step="0.1" id="ingredientCarbs" class="form-control" placeholder="0" required>
                    </div>
                </div>
                
                <div id="ingredientError" class="text-sm text-destructive hidden"></div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeModal('addIngredientModal')" 
                            class="btn btn-outline flex-1">
                        Отмена
                    </button>
                    <button type="submit" class="btn btn-primary flex-1">
                        Сохранить ингредиент
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования ингредиента -->

<div id="editIngredientModal" class="modal-overlay hidden">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Редактировать ингредиент</h2>
            <button onclick="closeModal('addIngredientModal')" class="btn btn-outline btn-icon">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <form id="editIngredientForm" class="space-y-4">
                <div>
                    <label class="form-label">Название ингредиента</label>
                    <input type="text" id="editIngredientName" class="form-control" placeholder="Например: Куриная грудка" required>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Калории (на 100г)</label>
                        <input type="number" step="0.1" id="editIngredientCalories" class="form-control" placeholder="165" required>
                    </div>
                    <div>
                        <label class="form-label">Белки (г на 100г)</label>
                        <input type="number" step="0.1" id="editIngredientProteins" class="form-control" placeholder="31" required>
                    </div>
                    <div>
                        <label class="form-label">Жиры (г на 100г)</label>
                        <input type="number" step="0.1" id="editIngredientFats" class="form-control" placeholder="3.6" required>
                    </div>
                    <div>
                        <label class="form-label">Углеводы (г на 100г)</label>
                        <input type="number" step="0.1" id="editIngredientCarbs" class="form-control" placeholder="0" required>
                    </div>
                </div>
                
                <div id="editIngredientError" class="text-sm text-destructive hidden"></div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeModal('editIngredientModal')" 
                            class="btn btn-outline flex-1">
                        Отмена
                    </button>
                    <button type="submit" class="btn btn-primary flex-1">
                        Сохранить изменения
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления -->
<div id="confirmDeleteModal" class="modal-overlay hidden">
    <div class="modal max-w-md">
        <div class="modal-header">
            <h2 class="modal-title">Подтверждение удаления</h2>
            <button onclick="closeModal('confirmDeleteModal')" class="btn btn-outline btn-icon">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <p id="deleteMessage" class="mb-6"></p>
            
            <div class="flex gap-3">
                <button onclick="closeModal('confirmDeleteModal')" 
                        class="btn btn-outline flex-1">
                    Отмена
                </button>
                <button id="confirmDeleteBtn" onclick="confirmDelete()" 
                        class="btn btn-destructive flex-1">
                    Удалить
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Глобальные переменные для удаления
    let currentDeleteAction = null;
    let currentDeleteId = null;
    let currentDeleteType = null;
    
    // Инициализация удаления
    document.addEventListener('click', function(e) {
        if (e.target.closest('[data-action="delete"]')) {
            const button = e.target.closest('[data-action="delete"]');
            const type = button.dataset.type;
            const id = button.dataset.id;
            const name = button.dataset.name;
            
            openDeleteModal(type, id, name);
        }
    });
    
    // Открытие модального окна удаления
    function openDeleteModal(type, id, name) {
        currentDeleteType = type;
        currentDeleteId = id;
        
        const typeText = type === 'recipe' ? 'рецепт' : 'ингредиент';
        document.getElementById('deleteMessage').textContent = 
            `Вы уверены, что хотите удалить ${typeText} "${name}"? Это действие нельзя отменить.`;
        
        openModal('confirmDeleteModal');
    }
    
    // Подтверждение удаления
    async function confirmDelete() {
        if (!currentDeleteType || !currentDeleteId) return;
        
        try {
            let url = '';
            if (currentDeleteType === 'recipe') {
                url = `/user/my-recipes/delete/${currentDeleteId}`;
            } else if (currentDeleteType === 'ingredient') {
                url = `/user/my-ingredients/delete/${currentDeleteId}`;
            }
            
            const response = await fetch(url, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification(data.message, 'success');
                closeModal('confirmDeleteModal');
                
                // Обновляем страницу через 1 секунду
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showNotification(data.message, 'error');
            }
        } catch (error) {
            showNotification('Ошибка при удалении. Попробуйте позже.', 'error');
        }
    }
    
    // Функция для добавления поля ингредиента в форму рецепта
    let ingredientCounter = 0;
    function addRecipeIngredientField() {
        const container = document.getElementById('recipeIngredientsContainer');
        if (!container) return;
        
        ingredientCounter++;
        const fieldId = `ingredient_${ingredientCounter}`;
        
        const fieldHtml = `
            <div class="flex gap-2" id="${fieldId}">
                <div class="flex-1">
                    <select class="form-control" name="ingredient_id">
                        <option value="">Выберите ингредиент</option>
                        <!-- Опции будут заполнены динамически -->
                    </select>
                </div>
                <div class="w-32">
                    <input type="number" step="1" class="form-control" 
                           name="ingredient_amount" placeholder="Граммы" required>
                </div>
                <button type="button" onclick="removeIngredientField('${fieldId}')" 
                        class="btn btn-outline btn-icon">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', fieldHtml);
        loadIngredientsForSelect(fieldId);
    }
    
    // Удаление поля ингредиента
    function removeIngredientField(fieldId) {
        const field = document.getElementById(fieldId);
        if (field) field.remove();
    }
    
    // Загрузка ингредиентов для выпадающего списка
    async function loadIngredientsForSelect(fieldId) {
        try {
            const response = await fetch('/user/ingredients');
            const ingredients = await response.json();
            
            const select = document.querySelector(`#${fieldId} select[name="ingredient_id"]`);
            if (!select) return;
            
            // Очищаем все кроме первого option
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Добавляем ингредиенты
            ingredients.forEach(ingredient => {
                const option = document.createElement('option');
                option.value = ingredient.id;
                option.textContent = ingredient.name;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Ошибка при загрузке ингредиентов:', error);
        }
    }
    
    // Обработка формы добавления рецепта
    document.getElementById('addRecipeForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const name = document.getElementById('recipeName').value;
        const description = document.getElementById('recipeDescription').value;
        const instructions = document.getElementById('recipeInstructions').value;
        const imageUrl = document.getElementById('recipeImageUrl').value;
        
        // Собираем ингредиенты
        const ingredients = [];
        const ingredientFields = document.querySelectorAll('#recipeIngredientsContainer > div');
        ingredientFields.forEach(field => {
            const ingredientId = field.querySelector('select[name="ingredient_id"]').value;
            const amount = field.querySelector('input[name="ingredient_amount"]').value;
            
            if (ingredientId && amount) {
                ingredients.push({
                    ingredient_id: parseInt(ingredientId),
                    amount: parseFloat(amount)
                });
            }
        });
        
        const errorElement = document.getElementById('recipeError');
        errorElement.classList.add('hidden');
        
        // Валидация
        if (!name || !instructions) {
            errorElement.textContent = 'Заполните обязательные поля';
            errorElement.classList.remove('hidden');
            return;
        }
        
        if (ingredients.length === 0) {
            errorElement.textContent = 'Добавьте хотя бы один ингредиент';
            errorElement.classList.remove('hidden');
            return;
        }
        
        try {
            const response = await fetch('/user/recipes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name,
                    description,
                    instructions,
                    image_url: imageUrl || null,
                    ingredients
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification(data.message, 'success');
                closeModal('addRecipeModal');
                
                // Сбрасываем форму
                this.reset();
                document.getElementById('recipeIngredientsContainer').innerHTML = '';
                ingredientCounter = 0;
                
                // Обновляем страницу через 1 секунду
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                errorElement.textContent = data.message;
                errorElement.classList.remove('hidden');
            }
        } catch (error) {
            errorElement.textContent = 'Ошибка сети. Попробуйте позже.';
            errorElement.classList.remove('hidden');
        }
    });
    
    // Простая функция для просмотра рецепта
    async function viewRecipe(recipeId) {
        try {
            openModal('viewRecipeModal');
            
            const response = await fetch(`/user/my-recipes/${recipeId}/details`);
            const data = await response.json();
            
            if (!data.success) {
                document.getElementById('viewRecipeContent').innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-muted-foreground">${data.message || 'Ошибка загрузки'}</p>
                    </div>
                `;
                return;
            }
            
            const recipe = data.recipe;
            const ingredients = data.ingredients;
            const nutrition = data.nutrition;
            
            document.getElementById('viewRecipeTitle').textContent = recipe.name;
            
            let html = `
                <div class="space-y-6">
                    <!-- Изображение и название -->
                    <div class="mb-4">
                        ${recipe.image_url ? `
                            <img src="${recipe.image_url}" alt="${recipe.name}" 
                                class="w-full h-64 object-cover rounded-lg mb-4">
                        ` : `
                            <div class="w-full h-48 bg-accent rounded-lg flex items-center justify-center mb-4">
                                <i class="bi bi-journal-text text-6xl text-muted-foreground"></i>
                            </div>
                        `}
                        
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xl font-medium">${recipe.name}</h3>
                            ${recipe.is_public ? `
                                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Общий</span>
                            ` : `
                                <span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">Мой</span>
                            `}
                        </div>
                        
                        ${recipe.description ? `
                            <p class="text-muted-foreground mb-4">${recipe.description}</p>
                        ` : ''}
                    </div>
                    
                    <!-- КБЖУ -->
                    <div class="grid grid-cols-4 gap-2 text-center p-4 bg-accent rounded-lg">
                        <div>
                            <div class="font-medium">${nutrition.calories}</div>
                            <div class="text-xs text-muted-foreground">ккал</div>
                        </div>
                        <div>
                            <div class="font-medium">${nutrition.proteins}г</div>
                            <div class="text-xs text-muted-foreground">белки</div>
                        </div>
                        <div>
                            <div class="font-medium">${nutrition.fats}г</div>
                            <div class="text-xs text-muted-foreground">жиры</div>
                        </div>
                        <div>
                            <div class="font-medium">${nutrition.carbs}г</div>
                            <div class="text-xs text-muted-foreground">углеводы</div>
                        </div>
                    </div>
                    
                    <!-- Ингредиенты -->
                    <div>
                        <h4 class="font-medium mb-3">Ингредиенты:</h4>
                        <div class="space-y-2">
            `;
            
            ingredients.forEach(ingredient => {
                html +=`
                    <div class="flex justify-between items-center p-3 bg-white dark:bg-gray-800 rounded-lg">
                    <div>
                            <span class="font-medium">${ingredient.name}</span>
                            <span class="text-sm text-muted-foreground ml-2">
                                ${ingredient.calories_per_100g} ккал/100г
                            </span>
                        </div>
                        <div class="font-medium">${ingredient.amount_grams}г</div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    
                    <!-- Инструкции -->
                    <div>
                        <h4 class="font-medium mb-3">Инструкции:</h4>
                        <div class="p-4 bg-white dark:bg-gray-800 rounded-lg">
                            <div class="whitespace-pre-line">${recipe.instructions}</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('viewRecipeContent').innerHTML = html;
            
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('viewRecipeContent').innerHTML = `
                <div class="text-center py-8">
                    <p class="text-muted-foreground">Ошибка загрузки рецепта</p>
                    <button onclick="closeModal('viewRecipeModal')" class="btn btn-outline mt-4">
                        Закрыть
                    </button>
                </div>
            `;
        }
    }

    // Глобальная переменная для ID редактируемого рецепта
    let editingRecipeId = null;

    // Функция открытия редактирования рецепта
    async function editRecipe(recipeId) {
        editingRecipeId = recipeId;
        
        try {
            // Загружаем данные рецепта
            const response = await fetch(`/user/my-recipes/${recipeId}/details`);
            const data = await response.json();
            
            if (!data.success) {
                showNotification(data.message, 'error');
                return;
            }
            
            const recipe = data.recipe;
            
            // Заполняем форму
            document.getElementById('editRecipeName').value = recipe.name;
            document.getElementById('editRecipeDescription').value = recipe.description || '';
            document.getElementById('editRecipeInstructions').value = recipe.instructions;
            document.getElementById('editRecipeImageUrl').value = recipe.image_url || '';
            
            const isPublicCheckbox = document.getElementById('editRecipeIsPublic');
            if (isPublicCheckbox && isAdmin) {
                isPublicCheckbox.checked = recipe.is_public;
            }
            
            // Загружаем ингредиенты
            await loadIngredientsForEditForm();
            
            // Добавляем ингредиенты рецепта
            const container = document.getElementById('editRecipeIngredientsContainer');
            container.innerHTML = '';
            
            if (data.ingredients && data.ingredients.length > 0) {
                data.ingredients.forEach((ingredient, index) => {
                    addEditIngredientField(ingredient.id, ingredient.amount_grams);
                });
            } else {
                // Добавляем одно пустое поле
                addEditIngredientField();
            }
            
            // Открываем модальное окно
            openModal('editRecipeModal');
            
        } catch (error) {
            console.error('Error loading recipe for edit:', error);
            showNotification('Ошибка при загрузке рецепта', 'error');
        }
    }

    // Функция добавления поля ингредиента в форму редактирования
    let editIngredientCounter = 0;

    async function addEditIngredientField(ingredientId = '', amount = '') {
        const container = document.getElementById('editRecipeIngredientsContainer');
        if (!container) return;
        
        editIngredientCounter++;
        const fieldId = `edit_ingredient_${editIngredientCounter}`;
        
        // Создаем поле
        const fieldHtml = `
            <div class="flex gap-2 items-center" id="${fieldId}">
                <div class="flex-1">
                    <select class="form-control edit-ingredient-select" name="ingredient_id" required>
                        <option value="">Выберите ингредиент</option>
                        <!-- Опции будут заполнены позже -->
                    </select>
                </div>
                <div class="w-32">
                    <input type="number" step="1" class="form-control" 
                        name="ingredient_amount" placeholder="Граммы" 
                        value="${amount || ''}" required>
                </div>
                <button type="button" onclick="removeEditIngredientField('${fieldId}')" 
                        class="btn btn-outline btn-icon">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', fieldHtml);
        
        // Заполняем выпадающий список
        await fillIngredientSelect(fieldId, ingredientId);
        }

        // Удаление поля ингредиента
        function removeEditIngredientField(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) field.remove();
        }

        // Загрузка ингредиентов для формы редактирования
        async function loadIngredientsForEditForm() {
            try {
                const response = await fetch('/user/ingredients');
                const ingredients = await response.json();
                
                // Сохраняем ингредиенты глобально для использования
                window.availableIngredients = ingredients;
                
            } catch (error) {
                console.error('Error loading ingredients:', error);
            }
        }

        // Заполнение конкретного select ингредиентами
    async function fillIngredientSelect(fieldId, selectedId = '') {
        const select = document.querySelector(`#${fieldId} select[name="ingredient_id"]`);
        if (!select) return;
        
        // Очищаем все кроме первого option
        while (select.options.length > 1) {
            select.remove(1);
        }
        
        // Если ингредиенты уже загружены
        if (window.availableIngredients) {
            window.availableIngredients.forEach(ingredient => {
                const option = document.createElement('option');
                option.value = ingredient.id;
                option.textContent = ingredient.name;
                option.selected = (ingredient.id == selectedId);
                select.appendChild(option);
            });
        } else {
            // Если еще не загружены, загружаем
            await loadIngredientsForEditForm();
            await fillIngredientSelect(fieldId, selectedId);
        }
    }

    // Обработчик формы редактирования рецепта
    document.getElementById('editRecipeForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!editingRecipeId) return;
        
        const name = document.getElementById('editRecipeName').value;
        const description = document.getElementById('editRecipeDescription').value;
        const instructions = document.getElementById('editRecipeInstructions').value;
        const imageUrl = document.getElementById('editRecipeImageUrl').value;
        const isPublic = document.getElementById('editRecipeIsPublic')?.checked || false;
        
        // Собираем ингредиенты
        const ingredients = [];
        const ingredientFields = document.querySelectorAll('#editRecipeIngredientsContainer > div');
        
        ingredientFields.forEach(field => {
            const ingredientId = field.querySelector('select[name="ingredient_id"]')?.value;
            const amount = field.querySelector('input[name="ingredient_amount"]')?.value;
            
            if (ingredientId && amount) {
                ingredients.push({
                    ingredient_id: parseInt(ingredientId),
                    amount: parseFloat(amount)
                });
            }
        });
        
        const errorElement = document.getElementById('editRecipeError');
        errorElement.classList.add('hidden');
        
        // Валидация
        if (!name.trim()) {
            errorElement.textContent = 'Введите название рецепта';
            errorElement.classList.remove('hidden');
            return;
        }
        
        if (!instructions.trim()) {
            errorElement.textContent = 'Введите инструкции приготовления';
            errorElement.classList.remove('hidden');
            return;
        }
        
        if (ingredients.length === 0) {
            errorElement.textContent = 'Добавьте хотя бы один ингредиент';
            errorElement.classList.remove('hidden');
            return;
        }
        
        try {
            const response = await fetch(`/user/my-recipes/${editingRecipeId}/update`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name.trim(),
                    description: description.trim(),
                    instructions: instructions.trim(),
                    image_url: imageUrl.trim() || null,
                    is_public: isPublic,
                    ingredients
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification(data.message, 'success');
                closeModal('editRecipeModal');
                
                // Сбрасываем форму
                this.reset();
                document.getElementById('editRecipeIngredientsContainer').innerHTML = '';
                editIngredientCounter = 0;
                editingRecipeId = null;
                
                // Обновляем страницу через 1 секунду
                setTimeout(() => {
                    location.reload();}, 1000);
                
            } else {
                errorElement.textContent = data.message;
                errorElement.classList.remove('hidden');
            }
            } catch (error) {
                errorElement.textContent = 'Ошибка сети. Попробуйте позже.';
                errorElement.classList.remove('hidden');
            }
        });



    // Обработка формы добавления ингредиента
    document.getElementById('addIngredientForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const name = document.getElementById('ingredientName').value;
        const calories = parseFloat(document.getElementById('ingredientCalories').value);
        const proteins = parseFloat(document.getElementById('ingredientProteins').value);
        const fats = parseFloat(document.getElementById('ingredientFats').value);
        const carbs = parseFloat(document.getElementById('ingredientCarbs').value);
        
        const errorElement = document.getElementById('ingredientError');
        errorElement.classList.add('hidden');
        
        // Валидация
        if (!name || isNaN(calories) || isNaN(proteins) || isNaN(fats) || isNaN(carbs)) {
            errorElement.textContent = 'Заполните все поля корректно';
            errorElement.classList.remove('hidden');
            return;
        }
        
        if (calories < 0 || proteins < 0 || fats < 0 || carbs < 0) {
            errorElement.textContent = 'Значения не могут быть отрицательными';
            errorElement.classList.remove('hidden');
            return;
        }
        
        try {
            const response = await fetch('/user/ingredients', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name,
                    calories,
                    proteins,
                    fats,
                    carbs,
                    is_public: false
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification(data.message, 'success');
                closeModal('addIngredientModal');
                
                // Сбрасываем форму
                this.reset();
                
                // Обновляем страницу через 1 секунду
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                errorElement.textContent = data.message;
                errorElement.classList.remove('hidden');
            }
        } catch (error) {
            errorElement.textContent = 'Ошибка сети. Попробуйте позже.';
            errorElement.classList.remove('hidden');
        }
    });
    
    // Автоматическое добавление первого поля ингредиента при открытии модального окна
    document.addEventListener('DOMContentLoaded', function() {
        // Отслеживаем открытие модального окна добавления рецепта
        const addRecipeModal = document.getElementById('addRecipeModal');
        if (addRecipeModal) {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (!addRecipeModal.classList.contains('hidden')) {
                        // Если контейнер пустой, добавляем первое поле
                        const container = document.getElementById('recipeIngredientsContainer');
                        if (container && container.children.length === 0) {
                            addRecipeIngredientField();
                        }
                    }
                });
            });
            
            observer.observe(addRecipeModal, {
                attributes: true,
                attributeFilter: ['class']
            });
        }
    });

// РЕДАКТИРОВАНИЕ ИНГРЕДИЕНТА
// Глобальная переменная для ID редактируемого ингредиента
let editingIngredientId = null;

// Функция открытия редактирования
async function editIngredient(ingredientId) {
    editingIngredientId = ingredientId;
    
    try {
        // Загружаем данные ингредиента
        const response = await fetch(`/user/ingredient/${ingredientId}/details`);
        const data = await response.json();
        
        if (!data.success) {
            showNotification(data.message, 'error');
            return;
        }

        // Открываем модальное окно
        openModal('editIngredientModal');
        
        // Заполняем форму
        document.getElementById('editIngredientName').value = data.ingredient.name;
        document.getElementById('editIngredientCalories').value = data.ingredient.calories;
        document.getElementById('editIngredientProteins').value = data.ingredient.proteins;
        document.getElementById('editIngredientFats').value = data.ingredient.fats;
        document.getElementById('editIngredientCarbs').value = data.ingredient.carbs;
        
        // Очищаем ошибки
        document.getElementById('editIngredientError').classList.add('hidden');
        
        
    } catch (error) {
        showNotification('Ошибка при загрузке ингредиента', 'error');
    }
}

// Обработчик формы редактирования
document.getElementById('editIngredientForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!editingIngredientId) return;
    
    const name = document.getElementById('editIngredientName').value;
    const calories = parseFloat(document.getElementById('editIngredientCalories').value);
    const proteins = parseFloat(document.getElementById('editIngredientProteins').value);
    const fats = parseFloat(document.getElementById('editIngredientFats').value);
    const carbs = parseFloat(document.getElementById('editIngredientCarbs').value);
    
    const errorElement = document.getElementById('editIngredientError');
    errorElement.classList.add('hidden');
    
    // Валидация (точно такая же как в добавлении)
    if (!name || isNaN(calories) || isNaN(proteins) || isNaN(fats) || isNaN(carbs)) {
        errorElement.textContent = 'Заполните все поля корректно';
        errorElement.classList.remove('hidden');
        return;
    }
    
    if (calories < 0 || proteins < 0 || fats < 0 || carbs < 0) {
        errorElement.textContent = 'Значения не могут быть отрицательными';
        errorElement.classList.remove('hidden');
        return;
    }
    
    try {
        const response = await fetch(`/user/ingredient/${editingIngredientId}/update`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name,
                calories,
                proteins,
                fats,
                carbs,
                is_public: false
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message, 'success');
            closeModal('editIngredientModal');
            
            // Сбрасываем форму
            this.reset();
            editingIngredientId = null;
            
            // Обновляем страницу
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            errorElement.textContent = data.message;
            errorElement.classList.remove('hidden');
        }
    } catch (error) {
        errorElement.textContent = 'Ошибка сети. Попробуйте позже.';
        errorElement.classList.remove('hidden');
    }
});
</script>

</body>
</html>