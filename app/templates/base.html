<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Что готовить{% endblock %}</title>
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    {% block head %}{% endblock %}
</head>
<body class="h-full bg-background text-foreground">
    <!-- Навигация -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="{{ url_for('index') }}" class="navbar-brand">
                <span>Что готовить</span>
            </a>
            
            <div class="navbar-menu">
                <a href="{{ url_for('index') }}" class="nav-link {% if request.endpoint == 'index' %}active{% endif %}">
                    <i class="bi bi-house-door"></i> Главная
                </a>
                
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('user.calculate') }}" class="nav-link {% if request.endpoint == 'user.calculate' %}active{% endif %}">
                        <i class="bi bi-calculator-fill"></i> Расчёт
                    </a>
                    <a href="{{ url_for('user.my_ingredients') }}" class="nav-link {% if request.endpoint == 'user.my_ingredients' %}active{% endif %}">
                        <i class="bi bi-basket"></i> Ингредиенты
                    </a>
                    <a href="{{ url_for('user.my_recipes') }}" class="nav-link {% if request.endpoint == 'user.my_recipes' %}active{% endif %}">
                        <i class="bi bi-journal-text"></i> Рецепты
                    </a>
                    
                    {% if current_user.is_admin %}
                        <a href="{{ url_for('admin.ingredients') }}" class="nav-link {% if request.endpoint == 'admin.ingredients' %}active{% endif %}">
                            <i class="bi bi-shield-check"></i> Админ
                        </a>
                    {% endif %}
                {% endif %}
            </div>
            
            <div class="flex items-center gap-4">
                {% if current_user.is_authenticated %}
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-sm font-medium">
                            {{ current_user.username[0]|upper }}
                        </div>
                    <span class="text-sm">{{ current_user.username }}</span>
                </div>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-outline btn-sm">
                    <i class="bi bi-box-arrow-right"></i> Выйти
                </a>
            {% else %}
                <button onclick="openModal('loginModal')" class="btn btn-outline btn-sm">
                    Войти
                </button>
                <button onclick="openModal('registerModal')" class="btn btn-primary btn-sm">
                    Регистрация
                </button>
            {% endif %}
        </div>
        </div>
    </nav>
    <!-- Flash сообщения -->
    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="space-y-2">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} fade-in">
                            <i class="bi 
                                {% if category == 'success' %}bi-check-circle
                                {% elif category == 'error' or category == 'danger' %}bi-exclamation-circle
                                {% elif category == 'warning' %}bi-exclamation-triangle
                                {% else %}bi-info-circle{% endif %}">
                            </i>
                            <span>{{ message }}</span>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
    </div>
    <!-- Основной контент -->
    <main class="main-content">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>
    <!-- Футер -->
    <footer class="footer">
        <div class="footer-content">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h4 class="font-medium">Nutrition Calculator</h4>
                    <p class="text-sm text-muted mt-1">
                        Система для расчёта и управления рационом питания
                    </p>
                </div>
                <div class="text-sm text-muted text-center md:text-right">
                    <p>Курсовая работа</p>
                    <p>Инструментальные средства информационных систем</p>
                </div>
            </div>
        </div>
    </footer>
    <!-- Модальные окна -->
    <div id="modalContainer"></div>
    <!-- Скрипты -->
    <script>
        // Утилиты
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
            }
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        // Закрытие модальных окон по клику вне контента
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.add('hidden');
            }
        });
        
        // Удаление элементов
        document.addEventListener('DOMContentLoaded', function() {
            // Кнопки удаления
            document.querySelectorAll('[data-delete]').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const type = this.dataset.type;
                    const id = this.dataset.id;
                    const name = this.dataset.name;
                    
                    if (confirm(`Удалить "${name}"?`)) {
                        fetch(`/api/${type}/delete/${id}`, {
                            method: 'DELETE'
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Плавное удаление элемента
                                const item = this.closest('tr') || this.closest('.card') || this.closest('[data-item]');
                                if (item) {
                                    item.style.opacity = '0';
                                    item.style.transform = 'translateY(-10px)';
                                    setTimeout(() => item.remove(), 300);
                                } else {
                                    location.reload();
                                }
                            } else {
                                alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                            }
                        });
                    }
                });
            });
            
            // Переключение публичности
            document.querySelectorAll('[data-toggle-public]').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const type = this.dataset.type;
                    const id = this.dataset.id;
                    
                    fetch(`/api/${type}/toggle-public/${id}`, {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        }
                    });
                });
            });
            
            // Автоматическое скрытие flash сообщений
            setTimeout(() => {
                document.querySelectorAll('.alert').forEach(alert => {
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 300);
                });
            }, 5000);
        });
        
        // Функция для добавления полей ингредиентов
        window.addIngredientField = function(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'flex gap-2 mb-2';
            div.innerHTML = `
                <select class="form-control flex-1" name="ingredient_${index}" required>
                    <option value="">Выберите ингредиент</option>
                    {% for ing in ingredients|default([]) %}
                    <option value="{{ ing.id }}">{{ ing.name }}</option>
                    {% endfor %}
                </select>
                <input type="number" class="form-control w-24" name="amount_${index}" placeholder="г" required min="1">
                <button type="button" class="btn btn-outline btn-icon" onclick="this.parentElement.remove()">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            container.appendChild(div);
        };
    </script>
    
    {% block scripts %}{% endblock %}
    <!-- Модальное окно входа -->
<div id="loginModal" class="modal-overlay hidden">
    <div class="modal max-w-md">
        <div class="modal-header">
            <h2 class="modal-title">Вход в систему</h2>
            <button onclick="closeModal('loginModal')" class="btn btn-outline btn-icon">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="example@email.com" required>
                </div>
                
                <div>
                    <label class="form-label">Пароль</label>
                    <input type="password" id="loginPassword" class="form-control" required>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="loginRemember" class="mr-2">
                    <label for="loginRemember" class="text-sm">Запомнить меня</label>
                </div>
                
                <div id="loginError" class="text-sm text-destructive hidden"></div>
                
                <button type="submit" class="btn btn-primary w-full">
                    <i class="bi bi-box-arrow-in-right"></i> Войти
                </button>
            </form>
            
            <div class="text-center mt-6">
                <p class="text-sm text-muted mb-2">Нет аккаунта?</p>
                <button onclick="switchToRegister()" class="btn btn-outline">
                    <i class="bi bi-person-plus"></i> Зарегистрироваться
                </button>
            </div>
            
            <div class="mt-6 pt-6 border-t border-border">
                <p class="text-sm text-muted mb-2"><strong>Тестовые аккаунты:</strong></p>
                <p class="text-xs text-muted">Администратор: admin@example.com / admin123</p>
                <p class="text-xs text-muted">Пользователь: user@example.com / user123</p>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно регистрации -->
<div id="registerModal" class="modal-overlay hidden">
    <div class="modal max-w-md">
        <div class="modal-header">
            <h2 class="modal-title">Регистрация</h2>
            <button onclick="closeModal('registerModal')" class="btn btn-outline btn-icon">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <form id="registerForm" class="space-y-4">
                <div>
                    <label class="form-label">Имя пользователя</label>
                    <input type="text" id="registerUsername" class="form-control" placeholder="Введите имя" required>
                    <p class="text-xs text-muted mt-1">От 2 до 64 символов</p>
                </div>
                
                <div>
                    <label class="form-label">Email</label>
                    <input type="email" id="registerEmail" class="form-control" placeholder="example@email.com" required>
                </div>
                
                <div>
                    <label class="form-label">Пароль</label>
                    <input type="password" id="registerPassword" class="form-control" required>
                    <p class="text-xs text-muted mt-1">Не менее 6 символов</p>
                </div>
                
                <div>
                    <label class="form-label">Повторите пароль</label>
                    <input type="password" id="registerPassword2" class="form-control" required>
                </div>
                
                <div id="registerError" class="text-sm text-destructive hidden"></div>
                <button type="submit" class="btn btn-primary w-full">
                    <i class="bi bi-person-plus"></i> Зарегистрироваться
                </button>
            </form>
            
            <div class="text-center mt-6">
                <p class="text-sm text-muted mb-2">Уже есть аккаунт?</p>
                <button onclick="switchToLogin()" class="btn btn-outline">
                    <i class="bi bi-box-arrow-in-right"></i> Войти
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Скрипты для работы с модальными окнами -->
<script>
    // Переключение между модальными окнами
    function switchToRegister() {
        closeModal('loginModal');
        setTimeout(() => openModal('registerModal'), 300);
    }
    
    function switchToLogin() {
        closeModal('registerModal');
        setTimeout(() => openModal('loginModal'), 300);
    }
    
    // Обработка формы входа
    document.getElementById('loginForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const remember = document.getElementById('loginRemember').checked;
        
        const errorElement = document.getElementById('loginError');
        errorElement.classList.add('hidden');
        
        try {
            const response = await fetch('/auth/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email, password, remember })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Показываем уведомление
                showNotification(data.message, 'success');
                
                // Закрываем модальное окно
                closeModal('loginModal');
                
                // Обновляем страницу
                setTimeout(() => location.reload(), 1000);
            } else {
                errorElement.textContent = data.message;
                errorElement.classList.remove('hidden');
            }
        } catch (error) {
            errorElement.textContent = 'Ошибка сети. Попробуйте позже.';
            errorElement.classList.remove('hidden');
        }
    });
    
    // Обработка формы регистрации
    document.getElementById('registerForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('registerUsername').value;
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        const password2 = document.getElementById('registerPassword2').value;
        
        const errorElement = document.getElementById('registerError');
        errorElement.classList.add('hidden');
        
        // Базовая валидация на клиенте
        if (username.length < 2 || username.length > 64) {
            errorElement.textContent = 'Имя пользователя должно быть от 2 до 64 символов';
            errorElement.classList.remove('hidden');
            return;
        }
        
        if (password.length < 6) {
            errorElement.textContent = 'Пароль должен быть не менее 6 символов';
            errorElement.classList.remove('hidden');
            return;
        }
        
        if (password !== password2) {
            errorElement.textContent = 'Пароли не совпадают';
            errorElement.classList.remove('hidden');
            return;
        }
        
        try {
            const response = await fetch('/auth/api/register', {method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, email, password, password2 })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Показываем уведомление
                showNotification(data.message, 'success');
                
                // Закрываем модальное окно
                closeModal('registerModal');
                
                // Обновляем страницу
                setTimeout(() => location.reload(), 1000);
            } else {
                errorElement.textContent = data.message;
                errorElement.classList.remove('hidden');
            }
        } catch (error) {
            errorElement.textContent = 'Ошибка сети. Попробуйте позже.';
            errorElement.classList.remove('hidden');
        }
    });
    
    // Функция для показа уведомлений
    function showNotification(message, type = 'info') {
        // Создаём элемент уведомления
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg fade-in ${
            type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' :
            type === 'error' ? 'bg-red-50 text-red-800 border border-red-200' :
            'bg-blue-50 text-blue-800 border border-blue-200'
        }`;
        notification.innerHTML = `
            <div class="flex items-center gap-2">
                <i class="bi ${
                    type === 'success' ? 'bi-check-circle' :
                    type === 'error' ? 'bi-exclamation-circle' :
                    'bi-info-circle'
                }"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Автоматическое скрытие через 5 секунд
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(20px)';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }
    
    // Автоматическое открытие модального окна при переходе на /login или /register
    document.addEventListener('DOMContentLoaded', function() {
        if (window.location.pathname === '/auth/login' || window.location.pathname === '/login') {
            openModal('loginModal');
            window.history.replaceState({}, document.title, '/');
        } else if (window.location.pathname === '/auth/register' || window.location.pathname === '/register') {
            openModal('registerModal');
            window.history.replaceState({}, document.title, '/');
        }
    });
</script>

</body>
</html>